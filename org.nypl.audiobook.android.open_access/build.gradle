apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'

dependencies {
  api project(':org.nypl.audiobook.android.api')

  implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
  implementation 'org.slf4j:slf4j-api:1.7.25'
  implementation 'joda-time:joda-time:2.9.9'
  implementation 'com.github.stephenc.jcip:jcip-annotations:1.0-1'
  implementation 'com.google.android.exoplayer:exoplayer:r1.5.15'
}

/*
 * Generate a properties file based on various settings.
 */

task generatePropertiesResources {

  def directory = new File(project.projectDir, "src/main/resources/org/nypl/audiobook/android/open_access").absoluteFile
  directory.mkdirs()
  def file = new File(directory, "provider.properties")
  file.createNewFile()

  def properties = new Properties()
  def major = version.split("\\.").getAt(0)
  def minor = version.split("\\.").getAt(1)
  def patch = version.split("\\.").getAt(2)
  properties.setProperty("version.major", major)
  properties.setProperty("version.minor", minor)
  properties.setProperty("version.patch", patch)
  properties.store(new FileOutputStream(file), "Automatically generated - DO NOT EDIT")
}

preBuild.dependsOn generatePropertiesResources

android {
  compileSdkVersion 27
  buildToolsVersion "27.0.3"

  packagingOptions {

  }
}

publishing {
  publications {
    debugAAR(MavenPublication) {
      groupId group
      artifactId 'org.nypl.audiobook.android.open_access'
      version version
      artifact("$buildDir/outputs/aar/org.nypl.audiobook.android.open_access-debug.aar")

      pom.withXml {
        def dependencies = asNode().appendNode('dependencies')

        final d0 = dependencies.appendNode('dependency')
        d0.appendNode('groupId', 'org.nypl.audiobook')
        d0.appendNode('artifactId', 'org.nypl.audiobook.android.api')
        d0.appendNode('version', version)

        final d1 = dependencies.appendNode('dependency')
        d1.appendNode('groupId', 'joda-time')
        d1.appendNode('artifactId', 'joda-time')
        d1.appendNode('version', '2.9.9')

        final d2 = dependencies.appendNode('dependency')
        d2.appendNode('groupId', 'org.slf4j')
        d2.appendNode('artifactId', 'slf4j-api')
        d2.appendNode('version', '1.7.25')

        final d3 = dependencies.appendNode('dependency')
        d3.appendNode('groupId', 'com.github.stephenc.jcip')
        d3.appendNode('artifactId', 'jcip-annotations')
        d3.appendNode('version', '1.0-1')

        final d4 = dependencies.appendNode('dependency')
        d4.appendNode('groupId', 'com.google.android.exoplayer')
        d4.appendNode('artifactId', 'exoplayer')
        d4.appendNode('version', 'r1.5.15')
      }
    }
  }

  repositories {
    maven {
      url "$buildDir/repo"
    }
  }
}
